<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1f2e">
    <title>Aviator - Telegram Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 50%, #2a3441 100%);
            color: white;
            overflow-x: hidden;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            position: fixed;
            width: 100%;
            height: 100%;
            overscroll-behavior: none;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            width: 100vw;
            max-width: 100%;
            margin: 0;
            background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 50%, #2a3441 100%);
            position: relative;
            overflow: hidden;
            border-radius: 0;
        }

        /* Mobile Header */
        .header {
            background: linear-gradient(135deg, #1a1f2e 0%, #2a3441 100%);
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid rgba(0, 255, 136, 0.3);
            backdrop-filter: blur(20px);
            position: relative;
            z-index: 10;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .menu-button {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .menu-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 70px;
            right: 20px;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: 1px solid #00ff88;
        }

        .connection-status.disconnected {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            border: 1px solid #ff4757;
        }

        .connection-status.connecting {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid #ffc107;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-icon {
            font-size: 24px;
            animation: float 3s ease-in-out infinite;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(45deg, #00d4ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .balance {
            background: rgba(0, 255, 136, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #00ff88;
            font-weight: 600;
        }

        /* Game Area */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: radial-gradient(circle at center, #1a2332 0%, #0f1419 100%);
        }

        .flight-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 20px;
            overflow: hidden;
        }

        .multiplier {
            font-size: 48px;
            font-weight: 900;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 20px currentColor;
            transition: all 0.1s ease;
        }

        .multiplier.flying {
            color: #00ff88;
            animation: pulse 0.5s ease-in-out infinite alternate;
        }

        .multiplier.crashed {
            color: #ff4757;
        }

        .multiplier.waiting {
            color: #ffc107;
        }

        .multiplier.betting {
            color: #00d4ff;
        }

        .plane {
            font-size: 80px;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 0 20px currentColor);
            position: relative;
            z-index: 5;
        }

        .plane.flying {
            color: #00ff88;
            animation: flyAdvanced 3s ease-in-out infinite, glow 2s ease-in-out infinite alternate;
            transform: translateY(-10px) rotate(-15deg);
        }

        .plane.crashed {
            color: #ff4757;
            animation: crash 0.8s ease-out forwards, explode 0.3s ease-out 0.5s forwards;
        }

        .plane.waiting {
            color: #ffc107;
            animation: idle 4s ease-in-out infinite;
            transform: translateY(5px);
        }

        .plane.betting {
            color: #00d4ff;
            animation: idle 4s ease-in-out infinite;
            transform: translateY(5px);
        }

        .plane.takeoff {
            color: #00ff88;
            animation: takeoff 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }

        .status {
            font-size: 18px;
            font-weight: 600;
            margin-top: 20px;
            text-align: center;
        }

        .status.flying {
            color: #00ff88;
        }

        .status.crashed {
            color: #ff4757;
        }

        .status.waiting {
            color: #ffc107;
        }

        .status.betting {
            color: #00d4ff;
        }

        /* Betting Controls */
        .betting-controls {
            background: linear-gradient(135deg, rgba(26, 31, 46, 0.95) 0%, rgba(42, 52, 65, 0.95) 100%);
            backdrop-filter: blur(25px);
            padding: 25px;
            border-top: 2px solid rgba(0, 255, 136, 0.3);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        }

        .bet-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .bet-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            font-size: 18px;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .bet-input:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.2);
        }

        .bet-btn {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: black;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 18px;
            min-width: 140px;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }

        .bet-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
            background: linear-gradient(135deg, #00ff88 0%, #00e676 100%);
        }

        .bet-btn:disabled {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            color: rgba(255, 255, 255, 0.4);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .bet-btn:active:not(:disabled) {
            transform: translateY(-1px);
        }

        .cashout-btn {
            background: linear-gradient(135deg, #ff4757 0%, #c44569 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3);
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .cashout-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4);
        }

        .cashout-btn:disabled {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Quick bet buttons */
        .quick-bets {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .quick-bet {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-bet:hover {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
        }

        /* Statistics */
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #00ff88;
        }

        /* History */
        .history {
            display: flex;
            gap: 4px;
            overflow-x: auto;
            padding: 10px 0;
            margin-bottom: 15px;
        }

        .history-item {
            min-width: 50px;
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .history-item.low {
            background: rgba(255, 71, 87, 0.2);
            border-color: #ff4757;
            color: #ff4757;
        }

        .history-item.medium {
            background: rgba(255, 193, 7, 0.2);
            border-color: #ffc107;
            color: #ffc107;
        }

        .history-item.high {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
            color: #00ff88;
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: black;
            padding: 15px 20px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 3000;
            animation: slideInNotification 0.3s ease;
            max-width: 300px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .notification.error {
            background: linear-gradient(135deg, #ff4757 0%, #c44569 100%);
            color: white;
        }

        .notification.warning {
            background: linear-gradient(135deg, #ffc107 0%, #f39c12 100%);
            color: black;
        }

        /* Enhanced Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.08); }
        }

        @keyframes flyAdvanced {
            0%, 100% { 
                transform: translateX(0px) translateY(-10px) rotate(-15deg); 
            }
            25% { 
                transform: translateX(15px) translateY(-20px) rotate(-20deg); 
            }
            50% { 
                transform: translateX(0px) translateY(-5px) rotate(-10deg); 
            }
            75% { 
                transform: translateX(-15px) translateY(-15px) rotate(-18deg); 
            }
        }

        @keyframes takeoff {
            0% { 
                transform: translateY(5px) rotate(0deg) scale(1); 
                opacity: 1;
            }
            30% { 
                transform: translateY(-10px) rotate(-10deg) scale(1.1); 
                opacity: 1;
            }
            100% { 
                transform: translateY(-15px) rotate(-15deg) scale(1.2); 
                opacity: 1;
            }
        }

        @keyframes crash {
            0% { 
                transform: translateY(-10px) rotate(-15deg) scale(1.2); 
                filter: drop-shadow(0 0 20px #00ff88);
            }
            50% { 
                transform: translateY(20px) rotate(180deg) scale(0.8); 
                filter: drop-shadow(0 0 30px #ff4757);
            }
            100% { 
                transform: translateY(40px) rotate(270deg) scale(0.5); 
                filter: drop-shadow(0 0 40px #ff4757);
                opacity: 0.3;
            }
        }

        @keyframes explode {
            0% { 
                opacity: 0.3; 
                transform: translateY(40px) rotate(270deg) scale(0.5);
            }
            50% { 
                opacity: 0.8; 
                transform: translateY(35px) rotate(315deg) scale(1.5);
                filter: drop-shadow(0 0 50px #ff4757) brightness(2);
            }
            100% { 
                opacity: 0; 
                transform: translateY(50px) rotate(360deg) scale(0.1);
                filter: drop-shadow(0 0 60px #ff4757) brightness(3);
            }
        }

        @keyframes idle {
            0%, 100% { 
                transform: translateY(5px) rotate(0deg); 
            }
            50% { 
                transform: translateY(-5px) rotate(3deg); 
            }
        }

        @keyframes glow {
            0% { 
                filter: drop-shadow(0 0 20px #00ff88); 
            }
            100% { 
                filter: drop-shadow(0 0 40px #00ff88) drop-shadow(0 0 60px #00ff88); 
            }
        }

        @keyframes slideInNotification {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 480px) {
            .header {
                padding: 10px 15px;
            }
            
            .multiplier {
                font-size: 36px;
            }
            
            .plane {
                font-size: 50px;
            }
            
            .betting-controls {
                padding: 15px;
            }
        }

        .menu-button#dotsMenuBtn {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 28px;
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            z-index: 20;
            padding: 0 10px;
            border-radius: 50%;
            transition: background 0.2s;
        }
        .menu-button#dotsMenuBtn:hover {
            background: rgba(255,255,255,0.1);
        }

        .dots-menu {
            position: absolute;
            top: 60px;
            right: 20px;
            background: rgba(26,31,46,0.98);
            border-radius: 12px;
            box-shadow: 0 4px 24px #0004;
            border: 1px solid #fff2;
            padding: 10px 0;
            min-width: 160px;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .menu-item {
            padding: 12px 24px;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s;
        }
        .menu-item:hover {
            background: rgba(0,255,136,0.15);
            color: #00ff88;
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .modal-content {
            background: #1a1f2e;
            border-radius: 16px;
            padding: 32px 24px;
            min-width: 320px;
            max-width: 90vw;
            box-shadow: 0 8px 32px #0008;
            position: relative;
        }
        .close {
            position: absolute;
            top: 12px; right: 18px;
            font-size: 28px;
            color: #fff;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="game-container" id="gameContainer">
        <!-- Connection Status -->
        <div class="connection-status disconnected" id="connectionStatus">
            üî¥ Connecting...
        </div>

        <!-- Header -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">‚úàÔ∏è</div>
                <div class="logo-text">AVIATOR</div>
            </div>
            <div class="user-info">
                <div class="balance" id="balance">1000‚≠ê</div>
                <button class="menu-button" id="menuBtn" title="Menu">‚ò∞</button>
            </div>
        </div>

        <!-- Game Area -->
        <div class="game-area">
            <div class="flight-display">
                <div class="multiplier waiting" id="multiplier">1.00x</div>
                <div class="plane waiting" id="plane">‚úàÔ∏è</div>
                <div class="status waiting" id="status">Connecting to server...</div>
            </div>
        </div>

        <!-- Betting Controls -->
        <div class="betting-controls">
            <div class="bet-section">
                <input type="number" class="bet-input" id="betAmount" placeholder="Bet Amount" value="100" min="10">
                <button class="bet-btn" id="placeBet" onclick="placeBet()">Place Bet</button>
            </div>
            <button class="cashout-btn" id="cashoutBtn" onclick="cashout()" disabled>Cash Out</button>
        </div>

        <!-- Main Menu (triggered by header ‚ò∞ button) -->
        <div class="dots-menu" id="dotsMenu" style="display:none;">
            <div class="menu-item" onclick="showHistory()">Game History</div>
            <div class="menu-item" onclick="showTransactions()">Transaction History</div>
            <div class="menu-item" onclick="showDeposit()">Deposit Funds</div>
            <div class="menu-item" onclick="showWithdraw()">Withdraw Funds</div>
            <div class="menu-item" onclick="showLeaderboard()">Leaderboard</div>
            <div class="menu-item" onclick="showProfile()">Profile</div>
        </div>

        <!-- Modals -->
        <div class="modal" id="historyModal" style="display:none;">
            <div class="modal-content">
                <span class="close" onclick="closeHistory()">&times;</span>
                <h3>Game History</h3>
                <div id="modalHistory"></div>
            </div>
        </div>
        <div class="modal" id="transactionsModal" style="display:none;">
            <div class="modal-content">
                <span class="close" onclick="closeTransactions()">&times;</span>
                <h3>Transaction History</h3>
                <div id="modalTransactions"></div>
            </div>
        </div>
        <div class="modal" id="depositModal" style="display:none;">
            <div class="modal-content">
                <span class="close" onclick="closeDeposit()">&times;</span>
                <h3>Deposit Funds</h3>
                <input type="number" id="depositAmount" placeholder="Amount" style="width:100%;margin-bottom:10px;">
                <input type="text" id="depositRef" placeholder="Reference" style="width:100%;margin-bottom:10px;">
                <button onclick="submitDeposit()" style="width:100%;">Submit Deposit</button>
                <div id="depositResult" style="margin-top:10px;"></div>
            </div>
        </div>
        <div class="modal" id="withdrawModal" style="display:none;">
            <div class="modal-content">
                <span class="close" onclick="closeWithdraw()">&times;</span>
                <h3>Withdraw Funds</h3>
                <input type="number" id="withdrawAmount" placeholder="Amount" style="width:100%;margin-bottom:10px;">
                <input type="text" id="withdrawRef" placeholder="Reference" style="width:100%;margin-bottom:10px;">
                <button onclick="submitWithdraw()" style="width:100%;">Submit Withdraw</button>
                <div id="withdrawResult" style="margin-top:10px;"></div>
            </div>
        </div>
        <div class="modal" id="leaderboardModal" style="display:none;">
            <div class="modal-content">
                <span class="close" onclick="closeLeaderboard()">&times;</span>
                <h3>Leaderboard</h3>
                <div id="modalLeaderboard"></div>
            </div>
        </div>
        <div class="modal" id="profileModal" style="display:none;">
            <div class="modal-content">
                <span class="close" onclick="closeProfile()">&times;</span>
                <h3>Profile</h3>
                <div id="modalProfile"></div>
            </div>
        </div>
    </div>

    <script>
      // Professional Aviator Game Engine
class AviatorGame {
    constructor() {
        // Game state
        this.gameState = 'waiting';
        this.currentMultiplier = 1.00;
        this.playerBet = 0;
        this.hasBet = false;
        this.balance = 1000;
        this.totalBet = 0;
        this.totalWin = 0;
        this.history = [2.34, 1.18, 5.67, 1.05, 8.92, 3.21, 1.73, 4.55, 2.89, 1.42];
        
        // Connection state
        this.socket = null;
        this.isConnected = false;
        this.demoMode = true;
        this.userTelegramId = Math.floor(Math.random() * 1000000000);
        
        // Game timing
        this.gameLoop = null;
        this.multiplierLoop = null;
        this.bettingTime = 10000; // 10 seconds
        this.maxFlightTime = 30000; // 30 seconds max
        
        // Audio system
        this.audioContext = null;
        this.soundEnabled = true;
        
        // DOM elements
        this.initDOMElements();
        this.initAudioSystem();
        
        // Start immediately
        this.initialize();
    }
    
    initDOMElements() {
        this.elements = {
            multiplier: document.getElementById('multiplier'),
            plane: document.getElementById('plane'),
            status: document.getElementById('status'),
            betAmount: document.getElementById('betAmount'),
            placeBet: document.getElementById('placeBet'),
            cashout: document.getElementById('cashoutBtn'),
            balance: document.getElementById('balance'),
            totalBet: document.getElementById('totalBet'),
            totalWin: document.getElementById('totalWin'),
            history: document.getElementById('history'),
            connectionStatus: document.getElementById('connectionStatus')
        };
    }
    
    initAudioSystem() {
        try {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
            console.log('Audio not supported');
        }
    }
    
    playSound(type) {
        if (!this.soundEnabled || !this.audioContext) return;
        
        try {
            const oscillator = this.audioContext.createOscillator();
            const gainNode = this.audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(this.audioContext.destination);
            
            switch (type) {
                case 'takeoff':
                    oscillator.frequency.setValueAtTime(200, this.audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(600, this.audioContext.currentTime + 0.5);
                    gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + 0.5);
                    break;
                    
                case 'crash':
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(600, this.audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(100, this.audioContext.currentTime + 0.8);
                    gainNode.gain.setValueAtTime(0.5, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.8);
                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + 0.8);
                    break;
                    
                case 'cashout':
                    [523.25, 659.25, 783.99].forEach((freq, i) => {
                        const osc = this.audioContext.createOscillator();
                        const gain = this.audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(this.audioContext.destination);
                        osc.frequency.value = freq;
                        osc.type = 'sine';
                        gain.gain.setValueAtTime(0, this.audioContext.currentTime + i * 0.1);
                        gain.gain.linearRampToValueAtTime(0.2, this.audioContext.currentTime + i * 0.1 + 0.05);
                        gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + i * 0.1 + 0.3);
                        osc.start(this.audioContext.currentTime + i * 0.1);
                        osc.stop(this.audioContext.currentTime + i * 0.1 + 0.3);
                    });
                    break;
                    
                case 'bet':
                    oscillator.type = 'square';
                    oscillator.frequency.value = 800;
                    gainNode.gain.setValueAtTime(0.2, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.1);
                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + 0.1);
                    break;
            }
        } catch (e) {
            console.log('Sound play failed:', e);
        }
    }
    
    initialize() {
        console.log('Initializing Aviator Game Engine...');
        
        // Set connection status
        this.elements.connectionStatus.textContent = 'Demo Mode';
        this.elements.connectionStatus.className = 'connection-status connecting';
        
        // Initialize display
        this.updateDisplay();
        this.updateHistory();
        this.updateStats();
        
        // Try server connection with timeout
        this.attemptServerConnection();
        
        // Start demo immediately
        setTimeout(() => {
            if (!this.isConnected) {
                this.startDemoMode();
            }
        }, 2000);
        
        console.log('Game engine ready');
    }
    
    attemptServerConnection() {
        try {
            this.socket = io(window.location.origin, {
                transports: ['websocket', 'polling'],
                timeout: 3000
            });
            
            this.socket.on('connect', () => {
                this.isConnected = true;
                this.demoMode = false;
                this.elements.connectionStatus.textContent = 'Connected';
                this.elements.connectionStatus.className = 'connection-status connected';
                this.showNotification('Connected to server', 'success');
                this.registerUser();
            });
            
            this.socket.on('disconnect', () => {
                this.isConnected = false;
                this.demoMode = true;
                this.elements.connectionStatus.textContent = 'Demo Mode';
                this.elements.connectionStatus.className = 'connection-status connecting';
            });
            
            this.socket.on('connect_error', () => {
                this.isConnected = false;
                this.demoMode = true;
            });
            
            // Game events
            this.setupSocketEvents();
            
        } catch (e) {
            console.log('Socket connection failed, using demo mode');
            this.demoMode = true;
        }
    }
    
    setupSocketEvents() {
        this.socket.on('game:bettingPhase', (data) => {
            this.gameState = 'betting';
            this.currentMultiplier = 1.00;
            this.hasBet = false;
            this.updateDisplay();
        });
        
        this.socket.on('game:takeoff', () => {
            this.gameState = 'flying';
            this.updateDisplay();
            this.playSound('takeoff');
        });
        
        this.socket.on('game:multiplierUpdate', (data) => {
            if (this.gameState === 'flying') {
                this.currentMultiplier = data.multiplier;
                this.updateDisplay();
            }
        });
        
        this.socket.on('game:crashed', (data) => {
            this.handleCrash(data.finalMultiplier);
        });
    }
    
    startDemoMode() {
        console.log('Starting stable demo mode');
        this.demoMode = true;
        this.showNotification('Demo mode - Fully functional!', 'info');
        this.runGameLoop();
    }
    
    runGameLoop() {
        // Clear any existing loops
        if (this.gameLoop) clearTimeout(this.gameLoop);
        if (this.multiplierLoop) clearInterval(this.multiplierLoop);
        
        // Start betting phase
        this.startBettingPhase();
    }
    
    startBettingPhase() {
        console.log('Starting betting phase');
        this.gameState = 'betting';
        this.currentMultiplier = 1.00;
        this.hasBet = false;
        this.updateDisplay();
        
        // Betting countdown
        let timeLeft = this.bettingTime / 1000;
        const countdown = setInterval(() => {
            timeLeft--;
            if (timeLeft <= 0) {
                clearInterval(countdown);
                this.startFlightPhase();
            }
        }, 1000);
        
        this.gameLoop = setTimeout(() => {
            clearInterval(countdown);
            this.startFlightPhase();
        }, this.bettingTime);
    }
    
    startFlightPhase() {
        console.log('Starting flight phase');
        this.gameState = 'flying';
        this.currentMultiplier = 1.00;
        this.updateDisplay();
        this.playSound('takeoff');
        
        // Generate crash point (provably fair simulation)
        const crashPoint = this.generateCrashPoint();
        console.log('Crash point set to:', crashPoint);
        
        // Calculate flight duration based on crash point
        const flightDuration = Math.min(
            this.maxFlightTime,
            Math.log(crashPoint) * 3000 + 2000
        );
        
        const startTime = Date.now();
        
        // Multiplier update loop
        this.multiplierLoop = setInterval(() => {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / flightDuration, 1);
            
            // Smooth exponential curve
            this.currentMultiplier = 1 + (crashPoint - 1) * Math.pow(progress, 0.7);
            this.updateDisplay();
            
            // Check if we've reached crash point
            if (this.currentMultiplier >= crashPoint || progress >= 1) {
                clearInterval(this.multiplierLoop);
                this.handleCrash(crashPoint);
            }
        }, 50); // 20 FPS for smooth animation
    }
    
    generateCrashPoint() {
        // Realistic crash point distribution
        const random = Math.random();
        
        if (random < 0.33) {
            // Low multipliers (1.0x - 2.0x) - 33%
            return 1.0 + Math.random() * 1.0;
        } else if (random < 0.75) {
            // Medium multipliers (2.0x - 10.0x) - 42%
            return 2.0 + Math.random() * 8.0;
        } else if (random < 0.95) {
            // High multipliers (10.0x - 50.0x) - 20%
            return 10.0 + Math.random() * 40.0;
        } else {
            // Very high multipliers (50.0x - 100.0x) - 5%
            return 50.0 + Math.random() * 50.0;
        }
    }
    
    handleCrash(crashPoint) {
        console.log('Game crashed at:', crashPoint);
        this.gameState = 'crashed';
        this.currentMultiplier = crashPoint;
        
        // Add to history
        this.history.unshift(crashPoint);
        if (this.history.length > 10) this.history.pop();
        this.updateHistory();
        
        // Handle player outcome
        if (this.hasBet) {
            // Player lost
            this.totalBet += this.playerBet;
            this.showNotification(
                `Crashed at ${crashPoint.toFixed(2)}x - Lost ${this.playerBet} stars`,
                'error'
            );
            this.playerBet = 0;
            this.hasBet = false;
            this.updateStats();
        }
        
        this.updateDisplay();
        this.playSound('crash');
        this.createExplosionEffect();
        
        // Wait before next round
        this.gameLoop = setTimeout(() => {
            this.runGameLoop();
        }, 5000);
    }
    
    // Player actions
    placeBet() {
        const betAmount = parseInt(this.elements.betAmount.value);
        
        if (this.gameState !== 'betting') {
            this.showNotification('Wait for betting phase!', 'warning');
            return;
        }
        
        if (betAmount < 10 || betAmount > this.balance) {
            this.showNotification('Invalid bet amount!', 'error');
            return;
        }
        
        if (this.hasBet) {
            this.showNotification('Bet already placed!', 'warning');
            return;
        }
        
        // Process bet
        this.balance -= betAmount;
        this.playerBet = betAmount;
        this.hasBet = true;
        
        this.playSound('bet');
        this.updateDisplay();
        this.showNotification(`Bet placed: ${betAmount} stars`, 'success');
        
        // Animate button
        this.elements.placeBet.style.transform = 'scale(0.95)';
        setTimeout(() => {
            this.elements.placeBet.style.transform = 'scale(1)';
        }, 150);
    }
    
    cashOut() {
        if (this.gameState !== 'flying' || !this.hasBet) {
            return;
        }
        
        const winAmount = Math.floor(this.playerBet * this.currentMultiplier);
        
        // Process cashout
        this.balance += winAmount;
        this.totalBet += this.playerBet;
        this.totalWin += winAmount;
        
        this.playSound('cashout');
        this.createWinEffect();
        this.updateDisplay();
        this.updateStats();
        
        this.showNotification(
            `Cashed out ${winAmount} stars at ${this.currentMultiplier.toFixed(2)}x!`,
            'success'
        );
        
        this.playerBet = 0;
        this.hasBet = false;
    }
    
    setBet(amount) {
        if (this.gameState === 'betting') {
            this.elements.betAmount.value = amount;
            this.playSound('bet');
        }
    }
    
    // Visual effects
    createExplosionEffect() {
        const container = document.createElement('div');
        container.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            pointer-events: none;
            z-index: 10;
        `;
        
        document.querySelector('.flight-display').appendChild(container);
        
        // Create particles
        for (let i = 0; i < 20; i++) {
            const particle = document.createElement('div');
            const angle = (i / 20) * Math.PI * 2;
            const distance = 40 + Math.random() * 60;
            const size = 4 + Math.random() * 6;
            
            particle.style.cssText = `
                position: absolute;
                width: ${size}px;
                height: ${size}px;
                background: #ff4757;
                border-radius: 50%;
                transform: translate(-50%, -50%);
            `;
            
            const endX = Math.cos(angle) * distance;
            const endY = Math.sin(angle) * distance;
            
            particle.animate([
                { transform: 'translate(-50%, -50%) scale(1)', opacity: 1 },
                { transform: `translate(calc(-50% + ${endX}px), calc(-50% + ${endY}px)) scale(0)`, opacity: 0 }
            ], {
                duration: 1000,
                easing: 'ease-out'
            });
            
            container.appendChild(particle);
        }
        
        setTimeout(() => container.remove(), 1000);
    }
    
    createWinEffect() {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, rgba(0, 255, 136, 0.3), rgba(0, 212, 255, 0.3));
            pointer-events: none;
            z-index: 5;
        `;
        
        document.querySelector('.flight-display').appendChild(overlay);
        
        overlay.animate([
            { opacity: 0 },
            { opacity: 1 },
            { opacity: 0 }
        ], {
            duration: 600,
            easing: 'ease-out'
        });
        
        // Scale multiplier
        this.elements.multiplier.style.transform = 'scale(1.2)';
        this.elements.multiplier.style.textShadow = '0 0 30px #00ff88';
        
        setTimeout(() => {
            this.elements.multiplier.style.transform = 'scale(1)';
            this.elements.multiplier.style.textShadow = '0 0 20px currentColor';
            overlay.remove();
        }, 600);
    }
    
    // UI Updates
    updateDisplay() {
        // Multiplier
        this.elements.multiplier.textContent = this.currentMultiplier.toFixed(2) + 'x';
        this.elements.multiplier.className = `multiplier ${this.gameState}`;
        
        // Plane
        this.elements.plane.className = `plane ${this.gameState}`;
        
        // Status
        const statusTexts = {
            waiting: 'Waiting for next round...',
            betting: `Place your bets! ${this.demoMode ? '(Demo)' : ''}`,
            flying: 'Flying! Cash out anytime!',
            crashed: `Crashed at ${this.currentMultiplier.toFixed(2)}x`
        };
        
        this.elements.status.textContent = statusTexts[this.gameState];
        this.elements.status.className = `status ${this.gameState}`;
        
        // Buttons
        this.elements.placeBet.disabled = this.gameState !== 'betting' || this.hasBet;
        this.elements.cashout.disabled = this.gameState !== 'flying' || !this.hasBet;
        
        // Cashout button text
        if (this.hasBet && this.gameState === 'flying') {
            const potentialWin = Math.floor(this.playerBet * this.currentMultiplier);
            this.elements.cashout.textContent = `Cash Out ${potentialWin} stars`;
        } else {
            this.elements.cashout.textContent = 'Cash Out';
        }
        
        // Balance
        this.elements.balance.textContent = this.balance + ' stars';
    }
    
    updateStats() {
        this.elements.totalBet.textContent = this.totalBet + ' stars';
        this.elements.totalWin.textContent = this.totalWin + ' stars';
    }
    
    updateHistory() {
        this.elements.history.innerHTML = '';
        this.history.forEach(mult => {
            const item = document.createElement('div');
            item.className = 'history-item';
            item.textContent = mult.toFixed(2) + 'x';
            
            if (mult < 2) item.classList.add('low');
            else if (mult < 5) item.classList.add('medium');
            else item.classList.add('high');
            
            this.elements.history.appendChild(item);
        });
    }
    
    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        const colors = {
            success: 'linear-gradient(135deg, #00ff88, #00cc6a)',
            error: 'linear-gradient(135deg, #ff4757, #c44569)',
            warning: 'linear-gradient(135deg, #ffc107, #f39c12)',
            info: 'linear-gradient(135deg, #17a2b8, #138496)'
        };
        
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${colors[type]};
            color: ${type === 'warning' ? 'black' : 'white'};
            padding: 15px 20px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 3000;
            max-width: 300px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            font-size: 14px;
        `;
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Animate in
        notification.animate([
            { transform: 'translateX(100%)', opacity: 0 },
            { transform: 'translateX(0)', opacity: 1 }
        ], { duration: 300, easing: 'ease-out' });
        
        // Auto remove
        setTimeout(() => {
            notification.animate([
                { transform: 'translateX(0)', opacity: 1 },
                { transform: 'translateX(100%)', opacity: 0 }
            ], { duration: 300, easing: 'ease-in' }).onfinish = () => {
                notification.remove();
            };
        }, 3000);
    }
    
    async registerUser() {
        try {
            const response = await fetch('/api/player/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    telegramId: this.userTelegramId,
                    username: `player${this.userTelegramId}`,
                    firstName: 'Demo',
                    lastName: 'Player'
                })
            });
            
            const data = await response.json();
            if (data.ok || data.success) {
                this.balance = data.user.balance || 1000;
                this.updateDisplay();
            }
        } catch (error) {
            console.log('Registration failed, using demo balance');
        }
    }
}

// Initialize game
let game = null;

// Global functions for button clicks
function setBet(amount) {
    game?.setBet(amount);
}

function placeBet() {
    game?.placeBet();
}

function cashout() {
    game?.cashOut();
}

function toggleMenu() {
    console.log('Menu toggle');
}

// Mobile viewport handling
function setVH() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    console.log('Initializing professional Aviator game...');
    
    // Set mobile viewport
    setVH();
    window.addEventListener('resize', setVH);
    
    // Create game instance
    game = new AviatorGame();
    
    console.log('Game ready!');
});

document.getElementById('dotsMenuBtn').onclick = function() {
    const menu = document.getElementById('dotsMenu');
    menu.style.display = menu.style.display === 'none' ? 'flex' : 'none';
};

document.getElementById('menuBtn').onclick = function() {
    const menu = document.getElementById('dotsMenu');
    menu.style.display = menu.style.display === 'none' ? 'flex' : 'none';
};

// Hide menu when clicking outside
document.addEventListener('click', function(e) {
    const menu = document.getElementById('dotsMenu');
    const btn = document.getElementById('menuBtn');
    if (menu.style.display !== 'none' && !menu.contains(e.target) && e.target !== btn) {
        menu.style.display = 'none';
    }
});

// Show history modal
function showHistory() {
    document.getElementById('dotsMenu').style.display = 'none';
    document.getElementById('historyModal').style.display = 'flex';
    const modalHistory = document.getElementById('modalHistory');
    modalHistory.innerHTML = '';
    game.history.forEach(mult => {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.textContent = mult.toFixed(2) + 'x';
        if (mult < 2) item.classList.add('low');
        else if (mult < 5) item.classList.add('medium');
        else item.classList.add('high');
        modalHistory.appendChild(item);
    });
}
function closeHistory() {
    document.getElementById('historyModal').style.display = 'none';
}

// Transaction modal
function showTransactions() {
    document.getElementById('dotsMenu').style.display = 'none';
    document.getElementById('transactionsModal').style.display = 'flex';
    const modalTransactions = document.getElementById('modalTransactions');
    modalTransactions.innerHTML = '<div>Loading...</div>';
    fetch('/api/player/history/' + game.userTelegramId)
        .then(res => res.json())
        .then(data => {
            if (data.ok && data.history) {
                modalTransactions.innerHTML = data.history.map(tx =>
                    `<div style="margin-bottom:8px;">
                        <b>${tx.type}</b> - ${tx.amount} stars<br>
                        <span style="font-size:12px;color:#888;">${new Date(tx.createdAt).toLocaleString()}</span>
                    </div>`
                ).join('');
            } else {
                modalTransactions.innerHTML = '<div>No transactions found.</div>';
            }
        }).catch(() => {
            modalTransactions.innerHTML = '<div>Error loading transactions.</div>';
        });
}
function closeTransactions() {
    document.getElementById('transactionsModal').style.display = 'none';
}

// Deposit modal
function showDeposit() {
    document.getElementById('dotsMenu').style.display = 'none';
    document.getElementById('depositModal').style.display = 'flex';
    document.getElementById('depositResult').innerHTML = '';
}
function closeDeposit() {
    document.getElementById('depositModal').style.display = 'none';
}
function submitDeposit() {
    const amount = document.getElementById('depositAmount').value;
    const ref = document.getElementById('depositRef').value;
    if (!amount || !ref) {
        document.getElementById('depositResult').innerHTML = '<span style="color:red;">Fill all fields</span>';
        return;
    }
    document.getElementById('depositResult').innerHTML = '<span style="color:green;">Deposit submitted!</span>';
    // Add API call if needed
}

// Withdraw modal
function showWithdraw() {
    document.getElementById('dotsMenu').style.display = 'none';
    document.getElementById('withdrawModal').style.display = 'flex';
    document.getElementById('withdrawResult').innerHTML = '';
}
function closeWithdraw() {
    document.getElementById('withdrawModal').style.display = 'none';
}
function submitWithdraw() {
    const amount = document.getElementById('withdrawAmount').value;
    const ref = document.getElementById('withdrawRef').value;
    if (!amount || !ref) {
        document.getElementById('withdrawResult').innerHTML = '<span style="color:red;">Fill all fields</span>';
        return;
    }
    document.getElementById('withdrawResult').innerHTML = '<span style="color:green;">Withdraw request submitted!</span>';
    // Add API call if needed
}

// Leaderboard modal
function showLeaderboard() {
    document.getElementById('dotsMenu').style.display = 'none';
    document.getElementById('leaderboardModal').style.display = 'flex';
    const modalLeaderboard = document.getElementById('modalLeaderboard');
    modalLeaderboard.innerHTML = '<div>Loading...</div>';
    fetch('/api/player/leaderboard')
        .then(res => res.json())
        .then(data => {
            if (data.ok && data.leaderboard) {
                modalLeaderboard.innerHTML = data.leaderboard.map((user, i) =>
                    `<div style="margin-bottom:8px;">
                        <b>#${i+1}</b> ${user.username || 'User'}<br>
                        Won: <span style="color:#00ff88;">${user.totalWon || 0}</span> | Balance: ${user.balance || 0}
                    </div>`
                ).join('');
            } else {
                modalLeaderboard.innerHTML = '<div>No leaderboard data.</div>';
            }
        }).catch(() => {
            modalLeaderboard.innerHTML = '<div>Error loading leaderboard.</div>';
        });
}
function closeLeaderboard() {
    document.getElementById('leaderboardModal').style.display = 'none';
}

// Profile modal
function showProfile() {
    document.getElementById('dotsMenu').style.display = 'none';
    document.getElementById('profileModal').style.display = 'flex';
    const modalProfile = document.getElementById('modalProfile');
    modalProfile.innerHTML = '<div>Loading...</div>';
    fetch('/api/player/profile/' + game.userTelegramId)
        .then(res => res.json())
        .then(data => {
            if (data.ok && data.user) {
                modalProfile.innerHTML = `
                    <div><b>Username:</b> ${data.user.username || 'N/A'}</div>
                    <div><b>Balance:</b> ${data.user.balance || 0} stars</div>
                    <div><b>Total Bets:</b> ${data.user.totalBets || 0}</div>
                    <div><b>Total Wagered:</b> ${data.user.totalWagered || 0}</div>
                    <div><b>Total Won:</b> ${data.user.totalWon || 0}</div>
                `;
            } else {
                modalProfile.innerHTML = '<div>No profile data.</div>';
            }
        }).catch(() => {
            modalProfile.innerHTML = '<div>Error loading profile.</div>';
        });
}
function closeProfile() {
    document.getElementById('profileModal').style.display = 'none';
}
        // JavaScript code for game functionality
  </script>
</body>
</html>